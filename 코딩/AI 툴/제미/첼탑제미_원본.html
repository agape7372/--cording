<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²¼íƒ‘ì•ˆí‹°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: #f5f5f7;
            margin: 0;
            padding: 0;
            padding-bottom: 70px; /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ê³µê°„ */
            color: #333;
        }

        /* ìƒë‹¨ í—¤ë” */
        .header {
            background-color: white;
            padding: 15px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .content {
            padding: 20px;
            display: none; /* íƒ­ ì „í™˜ì„ ìœ„í•´ ê¸°ë³¸ ìˆ¨ê¹€ */
        }
        .content.active {
            display: block;
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        input[type="number"], input[type="text"], input[type="file"], select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        button:active {
            background-color: #0056b3;
        }
        button.secondary {
            background-color: #e5e5ea;
            color: #333;
        }

        /* ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
        .result-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007AFF;
        }

        /* ì‹œê°„í‘œ ìŠ¤íƒ€ì¼ */
        .schedule-item {
            border-bottom: 1px solid #eee;
            padding: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .schedule-item:last-child {
            border-bottom: none;
        }
        .time-badge {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
        }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }
        .nav-item {
            text-align: center;
            flex: 1;
            color: #999;
            font-size: 12px;
            cursor: pointer;
        }
        .nav-item.active {
            color: #007AFF;
            font-weight: bold;
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            display: block;
        }

    </style>
</head>
<body>

    <div class="header">
        <h1 id="page-title">FIM ê³„ì‚°ê¸°</h1>
    </div>

    <div id="tab-calculator" class="content active">
        <div class="card">
            <h3>ë³´í–‰/ì´ë™ (L)</h3>
            <select id="walking_score">
                <option value="7">7ì  - ì™„ì „ ë…ë¦½</option>
                <option value="6">6ì  - ìˆ˜ì •ëœ ë…ë¦½ (ë³´ì¡°ê¸°êµ¬)</option>
                <option value="5">5ì  - ê°ë…/ì¤€ë¹„ (ì§€ì‹œ í•„ìš”)</option>
                <option value="4">4ì  - ìµœì†Œ ë³´ì¡° (75% ì´ìƒ)</option>
                <option value="3">3ì  - ì¤‘ê°„ ë³´ì¡° (50~74%)</option>
                <option value="2">2ì  - ìµœëŒ€ ë³´ì¡° (25~49%)</option>
                <option value="1">1ì  - ì „ì ì¸ ë³´ì¡° (25% ë¯¸ë§Œ)</option>
            </select>
        </div>
        <div class="card">
            <h3>ê³„ë‹¨ (M)</h3>
            <select id="stair_score">
                <option value="7">7ì  - ì™„ì „ ë…ë¦½</option>
                <option value="6">6ì  - ìˆ˜ì •ëœ ë…ë¦½ (ë³´ì¡°ê¸°êµ¬)</option>
                <option value="5">5ì  - ê°ë…/ì¤€ë¹„</option>
                <option value="4">4ì  - ìµœì†Œ ë³´ì¡°</option>
                <option value="3">3ì  - ì¤‘ê°„ ë³´ì¡°</option>
                <option value="2">2ì  - ìµœëŒ€ ë³´ì¡°</option>
                <option value="1">1ì  - ì „ì ì¸ ë³´ì¡°</option>
            </select>
        </div>
        <button onclick="calculateFIM()">ì ìˆ˜ ê³„ì‚°í•˜ê¸°</button>
        <div id="fim-result" class="result-box" style="display:none;"></div>
    </div>

    <div id="tab-schedule" class="content">
        <div class="card">
            <h3>ì¹˜ë£Œ ì‹œê°„í‘œ ì¶”ì¶œ</h3>
            <p style="font-size:14px; color:#666; margin-bottom:10px;">
                5ì¸µ ì¹˜ë£Œì‹œê°„í‘œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ í™˜ìì˜ ì‹œê°„í‘œë¥¼ ë½‘ì•„ì¤ë‹ˆë‹¤.
            </p>
            <input type="file" id="scheduleFile" accept=".xlsx, .xls">
            <input type="text" id="patientName" placeholder="í™˜ì ì´ë¦„ (ì˜ˆ: ì‹ ì—°ì• )">
            <button onclick="processScheduleFile()">ì‹œê°„í‘œ ê²€ìƒ‰</button>
        </div>
        <div id="schedule-result"></div>
    </div>

    <div id="tab-meal" class="content">
        <div class="card">
            <h3>ì˜¤ëŠ˜ì˜ ì‹ë‹¨</h3>
            <p style="text-align:center; color:#888; padding:20px;">
                ì¤€ë¹„ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤.<br>
                (ì´ë¯¸ì§€ë‚˜ í…ìŠ¤íŠ¸ ë·°ì–´ ì—°ë™ ê°€ëŠ¥)
            </p>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('calculator')">
            <span class="nav-icon">ğŸ§®</span>
            ê³„ì‚°ê¸°
        </div>
        <div class="nav-item" onclick="switchTab('schedule')">
            <span class="nav-icon">ğŸ“…</span>
            ì•„ì¹¨ì‹œê°„í‘œ
        </div>
        <div class="nav-item" onclick="switchTab('meal')">
            <span class="nav-icon">ğŸš</span>
            ì‹ë‹¨í‘œ
        </div>
    </div>

    <script>
        // --- íƒ­ ì „í™˜ ê¸°ëŠ¥ ---
        function switchTab(tabName) {
            // ëª¨ë“  ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            // ì„ íƒí•œ íƒ­ ë³´ì´ê¸°
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
            const navIndex = ['calculator', 'schedule', 'meal'].indexOf(tabName);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

            // íƒ€ì´í‹€ ë³€ê²½
            const titles = {'calculator': 'FIM ê³„ì‚°ê¸°', 'schedule': 'ì•„ì¹¨ ì‹œê°„í‘œ', 'meal': 'ì‹ë‹¨í‘œ'};
            document.getElementById('page-title').innerText = titles[tabName];
        }

        // --- 1. FIM ê³„ì‚°ê¸° ë¡œì§ ---
        function calculateFIM() {
            const walk = parseInt(document.getElementById('walking_score').value);
            const stair = parseInt(document.getElementById('stair_score').value);
            const sum = walk + stair;
            
            const resultDiv = document.getElementById('fim-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<strong>ì´ë™ í•­ëª© í•©ê³„: ${sum}ì </strong><br>ë³´í–‰: ${walk} / ê³„ë‹¨: ${stair}`;
        }

        // --- 2. ì•„ì¹¨ ì‹œê°„í‘œ ë¡œì§ (ìˆ˜ì •ëœ ë¶€ë¶„) ---
        const timeSlots = [
            "07:30", "08:00", "08:30", "09:05", "09:40", 
            "10:15", "10:50", "11:25", "12:00", "ì ì‹¬", 
            "13:30", "14:05", "14:40", "15:15", "15:50"
        ];

        function processScheduleFile() {
            const fileInput = document.getElementById('scheduleFile');
            const patientName = document.getElementById('patientName').value.trim();
            const resultDiv = document.getElementById('schedule-result');

            if (!fileInput.files.length) {
                alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!patientName) {
                alert('í™˜ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // ì²« ë²ˆì§¸ ì‹œíŠ¸ ì‚¬ìš©
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // JSON ë³€í™˜ (í—¤ë” í¬í•¨, ë°°ì—´ì˜ ë°°ì—´ í˜•íƒœ)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    let scheduleList = [];

                    // ë°ì´í„° ìˆœíšŒ
                    jsonData.forEach((row, rowIndex) => {
                        // ==========================================================
                        // [ìˆ˜ì •ë¨] ì¹˜ë£Œì‚¬ í•„í„°ë§ ë¡œì§
                        // ==========================================================
                        
                        // Bì—´(ì¸ë±ìŠ¤ 1)ì´ ì¹˜ë£Œì‚¬ ì´ë¦„ ì¹¸ì…ë‹ˆë‹¤.
                        let therapistName = row[1];

                        // ì œì™¸í•  í‚¤ì›Œë“œ ëª©ë¡ (N, CA, D, C, ì¶”ê°€ ë“±)
                        // ì´ í‚¤ì›Œë“œë¡œ ì‹œì‘í•˜ê±°ë‚˜, Bì—´ì´ ë¹„ì–´ìˆìœ¼ë©´ í•´ë‹¹ ì¤„ì€ ë¬´ì‹œí•©ë‹ˆë‹¤.
                        const excludeKeywords = ["N", "CA", "D", "C", "ì¶”ê°€", "ì ì‹¬", "ì‹œê°„", "ì¹˜ë£Œì‚¬"];
                        
                        if (!therapistName) {
                            return; // ì´ë¦„ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€
                        }

                        // therapistNameì„ ë¬¸ìì—´ë¡œ ë³€í™˜ í›„ ê³µë°±ì œê±°
                        let tNameStr = String(therapistName).trim();

                        // ì œì™¸ í‚¤ì›Œë“œë¡œ ì‹œì‘í•˜ëŠ”ì§€ ê²€ì‚¬
                        // ì˜ˆ: "Nì‹ ì—°ì• " ì²˜ëŸ¼ ì íŒ í–‰ì´ë‚˜, "ì¶”ê°€" ë¼ê³  ì íŒ í–‰ ì œê±°
                        if (excludeKeywords.some(keyword => tNameStr.startsWith(keyword))) {
                            return; // ê±´ë„ˆëœ€
                        }
                        // ==========================================================

                        // í•´ë‹¹ í–‰ì—ì„œ í™˜ì ì´ë¦„ ì°¾ê¸°
                        row.forEach((cell, cellIndex) => {
                            if (cell && String(cell).includes(patientName)) {
                                // ì‹œê°„ëŒ€ ì¸ë±ìŠ¤ ê³„ì‚° (Cì—´ë¶€í„° ì‹œê°„ì´ ì‹œì‘ëœë‹¤ê³  ê°€ì •: ì¸ë±ìŠ¤ 2ê°€ 07:30 or 08:30)
                                // ì—‘ì…€ íŒŒì¼ êµ¬ì¡°ìƒ Cì—´(2)ì´ ì²« ì‹œê°„.
                                // 11.17 íŒŒì¼ ê¸°ì¤€ Cì—´ì€ 7:30ì´ ì•„ë‹ˆë¼ 8:30 ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ íŒŒì¼ í—¤ë” ì°¸ê³  í•„ìš”
                                // ì¼ë‹¨ ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ cellIndex - 2 ë¡œ ë§¤í•‘
                                let timeIndex = cellIndex - 2;

                                if (timeIndex >= 0 && timeIndex < timeSlots.length) {
                                    scheduleList.push({
                                        time: timeSlots[timeIndex],
                                        content: String(cell).trim(), // ì¹˜ë£Œ ë‚´ìš©
                                        therapist: tNameStr // ë‹´ë‹¹ ì¹˜ë£Œì‚¬
                                    });
                                }
                            }
                        });
                    });

                    // ì‹œê°„ìˆœ ì •ë ¬ (timeSlots ìˆœì„œëŒ€ë¡œ)
                    scheduleList.sort((a, b) => {
                        return timeSlots.indexOf(a.time) - timeSlots.indexOf(b.time);
                    });

                    // ê²°ê³¼ HTML ìƒì„±
                    if (scheduleList.length === 0) {
                        resultDiv.innerHTML = `<div class="card" style="text-align:center; color:red;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì¶”ê°€ì¹˜ë£Œ(N/C/D)ë§Œ ìˆê±°ë‚˜ ì´ë¦„ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>`;
                    } else {
                        let html = `<div class="card"><h3>${patientName}ë‹˜ ì‹œê°„í‘œ</h3>`;
                        scheduleList.forEach(item => {
                            html += `
                                <div class="schedule-item">
                                    <div>
                                        <span class="time-badge">${item.time}</span>
                                        <span>${item.therapist}</span>
                                    </div>
                                    <div style="font-size:14px; color:#555;">${item.content}</div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                        
                        // ë³µì‚¬ ë²„íŠ¼
                        html += `<button class="secondary" onclick="copySchedule()">í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬</button>`;
                        
                        resultDiv.innerHTML = html;
                    }

                } catch (error) {
                    console.error(error);
                    alert('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜! ì—‘ì…€ íŒŒì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function copySchedule() {
            const resultDiv = document.getElementById('schedule-result');
            const text = resultDiv.innerText.replace('í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬', '').trim();
            
            navigator.clipboard.writeText(text).then(() => {
                alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                alert('ë³µì‚¬ ì‹¤íŒ¨ (ë³´ì•ˆ ì„¤ì • í™•ì¸ í•„ìš”)');
            });
        }

    </script>
</body>
</html>