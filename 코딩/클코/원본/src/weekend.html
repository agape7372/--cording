<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weekend Schedule</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        :root {
            --main-color: #00695c;
            --bg-color: #e9ecef;
            --sat-color: #1565C0;
            --sun-color: #C62828;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background-color: var(--bg-color);
            padding: 15px;
            font-family: 'Pretendard', sans-serif;
        }
        .ui-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-family: 'Malgun Gothic', sans-serif;
            position: relative;
        }
        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 20px;
        }
        .ui-header {
            color: var(--main-color);
            font-size: 1.4rem;
            font-weight: 800;
            margin: 0;
        }
        .btn-reset-icon {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #eceff1;
            color: #546e7a;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-reset-icon:hover {
            background: #cfd8dc;
            color: #d32f2f;
            transform: translateY(-50%) rotate(180deg);
        }
        .tooltip {
            position: absolute;
            bottom: -25px;
            right: -10px;
            font-size: 11px;
            background: #333;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            display: none;
            white-space: nowrap;
        }
        .btn-reset-icon:hover .tooltip {
            display: block;
        }
        .btn-help {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #2196F3;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn-help:hover {
            background: #1976D2;
        }
        .help-box {
            display: none;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196F3;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }
        .help-box.show {
            display: block;
        }
        .help-box h4 {
            color: #1565C0;
            margin: 0 0 10px 0;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .help-box .section {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #90CAF9;
        }
        .help-box .section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .help-box .tip {
            background: #E3F2FD;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 12px;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-row {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            color: white;
            width: 100%;
            transition: 0.2s;
        }
        .btn-gen {
            background: var(--main-color);
            font-size: 18px;
            box-shadow: 0 4px #004d40;
        }
        .btn-gen:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .btn-print {
            background: #455a64;
            flex: 1;
        }
        .btn-word {
            background: #d32f2f;
            flex: 1;
        }
        .btn-folder {
            background: #ff9800;
            color: white;
            margin-bottom: 10px;
            font-size: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .folder-status {
            font-size: 12px;
            color: #e65100;
            font-weight: bold;
            text-align: center;
            margin-top: -5px;
            margin-bottom: 10px;
            display: none;
        }
        .clear-btn {
            color: #d32f2f;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            z-index: 10;
            pointer-events: auto;
        }
        .upload-grid {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: stretch;
        }
        .upload-row {
            flex: 1;
            min-width: 100%;
            display: flex;
            gap: 6px;
            align-items: stretch;
        }
        @media (min-width: 600px) {
            .upload-row {
                min-width: 0;
                flex: 1;
            }
            .upload-grid {
                flex-wrap: nowrap;
            }
        }
        .upload-box {
            flex: 1;
            border: 2px dashed #ccc;
            background: #fafafa;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: 0.2s;
        }
        .upload-box.sat {
            border-color: var(--sat-color);
            background: #e3f2fd;
        }
        .upload-box.sun {
            border-color: var(--sun-color);
            background: #ffebee;
        }
        .upload-box.drag-over {
            background-color: #e0f2f1;
            border-color: var(--main-color);
            transform: scale(1.02);
        }
        .upload-box.locked {
            border-color: #4CAF50;
            background: #e8f5e9;
            cursor: default;
        }
        .box-label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        .box-label.sat {
            color: var(--sat-color);
        }
        .box-label.sun {
            color: var(--sun-color);
        }
        .file-name-display {
            font-size: 13px;
            color: var(--main-color);
            font-weight: bold;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            pointer-events: none;
        }
        .multi-input-area {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'Malgun Gothic', sans-serif;
            font-size: 15px;
            line-height: 1.5;
            resize: vertical;
        }
        .input-label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        .sort-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        .sort-options label {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        .sort-options select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        .date-input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .date-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .date-input-group label {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        .date-input-group label.sat {
            color: var(--sat-color);
        }
        .date-input-group label.sun {
            color: var(--sun-color);
        }
        .date-input-group input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        .date-input-group input[type="date"].sat {
            border-color: var(--sat-color);
        }
        .date-input-group input[type="date"].sun {
            border-color: var(--sun-color);
        }
        .btn-auto-date {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #7c4dff;
            color: white;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-auto-date:hover {
            background: #651fff;
        }
        .date-display {
            font-size: 13px;
            color: #555;
            margin-left: 5px;
        }
        #debugWindow {
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            background: #263238;
            color: #a5d6a7;
            font-size: 11px;
            font-family: monospace;
            border-radius: 8px;
            height: 120px;
            overflow-y: auto;
        }
        #previewList {
            display: none;
            margin-top: 30px;
            flex-direction: column;
            gap: 20px;
            align-items: flex-start;
            width: 100%;
            overflow-x: auto;
        }
        .preview-item-wrapper {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            background: transparent;
            padding: 0;
            position: relative;
        }
        /* ì£¼ë§ ì‹œê°„í‘œ: ì„¸ë¡œë¡œ ë‘ ê°œ (ìƒ: í† , í•˜: ì¼) */
        .preview-paper {
            width: 210mm !important;
            min-width: 210mm !important;
            height: 297mm !important;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            text-align: left;
            transform-origin: top left;
            margin: 0;
            padding: 5mm 8mm !important;
            display: flex;
            flex-direction: column;
        }
        .half-schedule {
            width: 100%;
            height: 50%;
            padding: 3mm 0;
            box-sizing: border-box;
            position: relative;
        }
        .half-schedule:first-child {
            border-bottom: 1px dashed #ccc;
        }
        .half-schedule.no-treatment {
            background: #f5f5f5;
        }
        .half-schedule.no-treatment .schedule-table td.treatment-text,
        .half-schedule.no-treatment .schedule-table td.col-remark {
            background: #e0e0e0;
            color: #9e9e9e;
        }
        @media (max-width: 820px) {
            .preview-paper {
                transform: scale(0.42);
                margin-bottom: -170mm;
                margin-right: -120mm;
            }
            .preview-item-wrapper {
                height: 460px;
                align-items: flex-start;
            }
        }
        @media (min-width: 821px) {
            .preview-paper {
                transform: scale(0.8);
                margin-bottom: -60mm;
                transform-origin: top center;
                margin: 0 auto;
            }
            .preview-item-wrapper {
                justify-content: center;
                height: 850px;
            }
        }
        #printContainer {
            display: none;
        }
        /* ì¸ì‡„ìš©: A4 ê°€ë¡œì— 2ëª…ì”© ì¢Œìš° ë°°ì¹˜ */
        .print-page-row {
            width: 297mm !important;
            height: 210mm !important;
            margin: 0 auto;
            background: white;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            page-break-after: always;
            overflow: hidden;
        }
        .print-page-row:last-child {
            page-break-after: auto;
        }
        .print-half {
            width: 50%;
            height: 100%;
            padding: 5mm 7mm;
            box-sizing: border-box;
            zoom: 0.72;
            border-right: 1px dashed #ddd;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .print-half:last-child {
            border-right: none;
        }
        .print-half .half-schedule {
            height: 50%;
            padding: 2mm 0;
        }
        .print-half .half-schedule:first-child {
            border-bottom: 1px dashed #ccc;
        }
        /* ê³µí†µ ë¬¸ì„œ ìŠ¤íƒ€ì¼ */
        .doc-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 3px;
            border-bottom: 3px solid var(--main-color);
            padding-bottom: 5px;
        }
        .cl-logo {
            font-size: 28px;
            font-weight: bold;
            font-style: italic;
            line-height: 1;
        }
        .cl-c {
            color: #d4a017;
        }
        .cl-l {
            color: #006400;
        }
        .main-title {
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            flex: 1;
            letter-spacing: -1px;
        }
        .day-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 8px;
        }
        .day-badge.sat {
            background: var(--sat-color);
            color: white;
        }
        .day-badge.sun {
            background: var(--sun-color);
            color: white;
        }
        .patient-info {
            margin: 6px 0 8px;
            font-size: 18px;
            font-weight: bold;
        }
        .info-underline {
            display: inline-block;
            border-bottom: 2px solid #333;
            min-width: 70px;
            text-align: center;
            padding: 0 5px;
            color: var(--main-color);
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            border-top: 2px solid #000;
            border-bottom: 2px solid #000;
            margin-top: 5px;
        }
        .schedule-table th,
        .schedule-table td {
            border: 1px solid #000;
            text-align: center;
            vertical-align: middle;
            padding: 0;
            font-weight: bold;
        }
        .schedule-table th {
            background: #e0f2f1;
            height: 28px;
            font-size: 14px;
            font-weight: bold;
        }
        .row-height {
            height: 28px;
        }
        .col-ampm {
            width: 28px;
            background: #f9f9f9;
            font-weight: bold;
            font-size: 13px;
            color: #444;
            white-space: nowrap;
        }
        .col-num {
            width: 28px;
            font-weight: bold;
            font-size: 14px;
            font-family: "Times New Roman";
        }
        .col-time {
            width: 100px;
            font-weight: bold;
            font-size: 15px;
            font-family: "Times New Roman";
            letter-spacing: -0.5px;
            white-space: nowrap;
        }
        .treatment-text {
            width: auto;
            font-size: 24px;
            font-weight: 900;
            white-space: pre-line;
            line-height: 1.1;
            color: #000;
        }
        .col-remark {
            font-size: 22px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0 5px;
            color: #333;
        }
        .text-vertical {
            writing-mode: vertical-lr;
            text-orientation: upright;
            letter-spacing: 3px;
        }
        .no-treatment-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: #9e9e9e;
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 10;
            display: none;
        }
        .half-schedule.no-treatment .no-treatment-overlay {
            display: block;
        }
        /* ì¹˜ë£Œ ì—†ëŠ” ë‚  ê°„ë‹¨ í‘œì‹œ (ì‰í¬ ì ˆì•½) */
        .no-treatment-simple {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }
        .no-treatment-message {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 30px;
            background: white;
            border: 2px dashed #ccc;
            border-radius: 12px;
        }
        .no-treatment-message .day-badge {
            font-size: 16px;
            padding: 5px 15px;
            margin-left: 0;
        }
        .no-tx-text {
            font-size: 22px;
            font-weight: bold;
            color: #9e9e9e;
        }
        [contenteditable="true"]:hover {
            background-color: #e3f2fd;
            cursor: text;
            outline: 1px dashed #2196F3;
        }
        [contenteditable="true"]:focus {
            background-color: #fff;
            outline: 2px solid #2196F3;
            box-shadow: 0 0 5px rgba(33,150,243,0.5);
        }
        @media print {
            @page {
                size: A4 landscape;
                margin: 0;
            }
            body {
                background: white;
                padding: 0;
            }
            .ui-container, #previewList {
                display: none !important;
            }
            #printContainer {
                display: block !important;
                margin: 0;
                width: 100%;
            }
            .print-page-row {
                width: 297mm !important;
                height: 210mm !important;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .print-half {
                width: 50%;
                height: 100%;
                padding: 5mm 7mm;
                box-sizing: border-box;
                zoom: 0.72;
                box-shadow: none;
                border-right: 1px dashed #ddd;
            }
            .print-half:last-child {
                border-right: none;
            }
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            [contenteditable="true"] {
                outline: none !important;
                background: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="ui-container">
        <div class="header-row">
            <button class="btn-help" onclick="toggleHelp()" title="ì‚¬ìš©ë²• ë³´ê¸°">â“</button>
            <h2 class="ui-header">ğŸ“… ì£¼ë§ ì‹œê°„í‘œ (í† /ì¼ í†µí•©)</h2>
            <button class="btn-reset-icon" onclick="resetAll()" title="ëª¨ë‘ ì´ˆê¸°í™”">â†»<span class="tooltip">ëª¨ë‘ ì´ˆê¸°í™”</span></button>
        </div>

        <div id="helpBox" class="help-box">
            <div class="section">
                <h4>ğŸ“‹ ê¸°ë³¸ ì‚¬ìš©ë²•</h4>
                â‘  í† ìš”ì¼/ì¼ìš”ì¼ ì‹œê°„í‘œ íŒŒì¼ ì—…ë¡œë“œ â†’ â‘¡ í™˜ì ì´ë¦„ ì…ë ¥ â†’ â‘¢ ì‹œê°„í‘œ ìƒì„± â†’ â‘£ ì €ì¥/ì¸ì‡„
            </div>
            <div class="section">
                <h4>âœ¨ ì£¼ìš” íŠ¹ì§•</h4>
                â€¢ <b>í•œ ì¥ì— í† /ì¼ í†µí•©</b> â†’ A4 ìš©ì§€ ì ˆì•½, í•œëˆˆì— ì£¼ë§ ì¼ì • í™•ì¸<br>
                â€¢ <b>ì¹˜ë£Œ ì—†ëŠ” ë‚  ê°„ì†Œí™”</b> â†’ í•´ë‹¹ ìš”ì¼ì— ì¹˜ë£Œê°€ ì—†ìœ¼ë©´ í‘œ ëŒ€ì‹  ê°„ë‹¨í•œ ì•ˆë‚´ í‘œì‹œ (ì‰í¬ ì ˆì•½)<br>
                â€¢ <b>í˜¸ì‹¤ë³„ ì •ë ¬</b> â†’ ë°°ë¶€ ì‹œ í¸ì˜ë¥¼ ìœ„í•œ ìë™ ì •ë ¬ ê¸°ëŠ¥
            </div>
            <div class="section">
                <h4>ğŸ“‚ ì €ì¥ í´ë” ì—°ê²° (PC ì „ìš©)</h4>
                â€¢ <b>ì—°ê²° O</b> â†’ ì§€ì •í•œ í´ë”ì— ìë™ ì €ì¥<br>
                â€¢ <b>ì—°ê²° X</b> â†’ ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥
            </div>
            <div class="tip">ğŸ’¡ ì˜¤ì „ ì‹œê°„í‘œë§Œ ì¶œë ¥ë˜ë©°, ì£¼ë§ ìš´ì˜ì‹œê°„(08:30~12:30)ì— ë§ì¶°ì ¸ ìˆìŠµë‹ˆë‹¤.</div>
        </div>

        <div class="date-input-row">
            <div class="date-input-group">
                <label class="sat">ğŸ“… í† ìš”ì¼:</label>
                <input type="date" id="satDate" class="sat" onchange="updateDateDisplay()">
                <span class="date-display" id="satDateDisplay"></span>
            </div>
            <div class="date-input-group">
                <label class="sun">ğŸ“… ì¼ìš”ì¼:</label>
                <input type="date" id="sunDate" class="sun" onchange="updateDateDisplay()">
                <span class="date-display" id="sunDateDisplay"></span>
            </div>
            <button class="btn-auto-date" onclick="setNextWeekend()">ë‹¤ê°€ì˜¤ëŠ” ì£¼ë§ ìë™ ì„¤ì •</button>
        </div>

        <div class="upload-grid">
            <div class="upload-row">
                <div class="upload-box sat" id="boxSat" onclick="selectFile('sat')">
                    <div class="box-label sat">ğŸ“‚ í† ìš”ì¼ íŒŒì¼</div>
                    <div class="file-name-display" id="nameSat"><span class="placeholder">ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span></div>
                    <input type="file" id="fileSat" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileSelect('sat')">
                </div>
            </div>
            <div class="upload-row">
                <div class="upload-box sun" id="boxSun" onclick="selectFile('sun')">
                    <div class="box-label sun">ğŸ“‚ ì¼ìš”ì¼ íŒŒì¼</div>
                    <div class="file-name-display" id="nameSun"><span class="placeholder">ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span></div>
                    <input type="file" id="fileSun" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileSelect('sun')">
                </div>
            </div>
        </div>

        <div>
            <label class="input-label">í™˜ì ëª©ë¡ ì…ë ¥ (ì´ë¦„ ì°¨íŠ¸ë²ˆí˜¸ í˜¸ì‹¤)</label>
            <textarea id="patientInputList" class="multi-input-area" placeholder="ì˜ˆì‹œ : ì´ë¦„ ì°¨íŠ¸ë²ˆí˜¸ í˜¸ì‹¤&#10;í™ê¸¸ë™ 111111 501&#10;í™í‚¤í‚¤ 222222 502&#10;í™ë”©ë”© 333333 601"></textarea>
            <div class="sort-options">
                <label>ì •ë ¬ ê¸°ì¤€:</label>
                <select id="sortOption">
                    <option value="none">ì •ë ¬ ì•ˆí•¨ (ì…ë ¥ ìˆœì„œ)</option>
                    <option value="room">í˜¸ì‹¤ë³„ ì˜¤ë¦„ì°¨ìˆœ</option>
                    <option value="room-desc">í˜¸ì‹¤ë³„ ë‚´ë¦¼ì°¨ìˆœ</option>
                    <option value="name">ì´ë¦„ìˆœ</option>
                </select>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-folder" onclick="setSaveFolder()">ğŸ“‚ ì €ì¥ í´ë” ë¯¸ë¦¬ ì—°ê²°í•˜ê¸° (í´ë¦­)</button>
            <div id="folderStatus" class="folder-status">ì—°ê²°ëœ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <button class="btn btn-gen" onclick="generateAllSchedules()">ğŸš€ ì£¼ë§ ì‹œê°„í‘œ ìƒì„±í•˜ê¸°</button>
            <div class="btn-row">
                <button class="btn btn-print" onclick="printWithGuide()">ğŸ–¨ï¸ ì „ì²´ ì¸ì‡„</button>
                <button class="btn btn-word" onclick="saveAsWord()">ğŸ’¾ HTML ì €ì¥</button>
            </div>
        </div>

        <div id="debugWindow">í† ìš”ì¼, ì¼ìš”ì¼ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</div>
    </div>

    <div id="previewList"></div>
    <div id="printContainer"></div>

    <script>
        function toggleHelp() {
            const box = document.getElementById("helpBox");
            box.classList.toggle("show");
        }

        const loadedFiles = { sat: null, sun: null };
        const loadedWorkbooks = { sat: null, sun: null };
        let generatedPatients = [];
        let globalDirHandle = null;
        let weekendDates = { sat: null, sun: null };

        // ë‚ ì§œ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function formatDateKorean(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayName = dayNames[date.getDay()];
            return `${month}ì›” ${day}ì¼ (${dayName})`;
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function setNextWeekend() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=ì¼, 6=í† 

            let satDate, sunDate;

            if (dayOfWeek === 6) {
                // ì˜¤ëŠ˜ì´ í† ìš”ì¼ì´ë©´ ì˜¤ëŠ˜ê³¼ ë‚´ì¼
                satDate = new Date(today);
                sunDate = new Date(today);
                sunDate.setDate(sunDate.getDate() + 1);
            } else if (dayOfWeek === 0) {
                // ì˜¤ëŠ˜ì´ ì¼ìš”ì¼ì´ë©´ ì–´ì œì™€ ì˜¤ëŠ˜
                satDate = new Date(today);
                satDate.setDate(satDate.getDate() - 1);
                sunDate = new Date(today);
            } else {
                // í‰ì¼ì´ë©´ ë‹¤ê°€ì˜¤ëŠ” í† ìš”ì¼ ê³„ì‚°
                const daysUntilSat = 6 - dayOfWeek;
                satDate = new Date(today);
                satDate.setDate(satDate.getDate() + daysUntilSat);
                sunDate = new Date(satDate);
                sunDate.setDate(sunDate.getDate() + 1);
            }

            // inputì— ê°’ ì„¤ì • (ë¡œì»¬ ì‹œê°„ëŒ€ ì‚¬ìš©)
            const formatLocalDate = (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const satStr = formatLocalDate(satDate);
            const sunStr = formatLocalDate(sunDate);

            getEl('satDate').value = satStr;
            getEl('sunDate').value = sunStr;
            weekendDates.sat = satStr;
            weekendDates.sun = sunStr;

            updateDateDisplay();
            log("ğŸ“… ì£¼ë§ ë‚ ì§œ ìë™ ì„¤ì •: " + formatDateKorean(satStr) + " ~ " + formatDateKorean(sunStr));
        }

        function updateDateDisplay() {
            const satVal = getEl('satDate').value;
            const sunVal = getEl('sunDate').value;

            weekendDates.sat = satVal;
            weekendDates.sun = sunVal;

            getEl('satDateDisplay').textContent = satVal ? formatDateKorean(satVal) : '';
            getEl('sunDateDisplay').textContent = sunVal ? formatDateKorean(sunVal) : '';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¤ê°€ì˜¤ëŠ” ì£¼ë§ ìë™ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            setNextWeekend();
        });

        // ì£¼ë§ ì˜¤ì „ ì‹œê°„í‘œ ìŠ¬ë¡¯ (08:30 - 12:30)
        const WEEKEND_SCHEDULE_SLOTS = [
            { id: 1, times: ['08:30 - 08:45', '08:45 - 09:00'], type: 'am', targetMin: 510 },
            { id: 2, times: ['09:05 - 09:20', '09:20 - 09:35'], type: 'am', targetMin: 545 },
            { id: 3, times: ['09:40 - 09:55', '09:55 - 10:10'], type: 'am', targetMin: 580 },
            { id: 4, times: ['10:15 - 10:30', '10:30 - 10:45'], type: 'am', targetMin: 615 },
            { id: 5, times: ['10:50 - 11:05', '11:05 - 11:20'], type: 'am', targetMin: 650 },
            { id: 6, times: ['11:25 - 11:40', '11:40 - 11:55'], type: 'am', targetMin: 685 },
            { id: 7, times: ['12:00 - 12:15', '12:15 - 12:30'], type: 'am', targetMin: 720 }
        ];

        // ì¹˜ë£Œ ì½”ë“œ ë§¤í•‘ (ì•„ì¹¨ ì‹œê°„í‘œì™€ ë™ì¼)
        const TREATMENT_CODES = {
            'ESWT': 'ì¶©ê²©íŒŒ ì¹˜ë£Œ',
            'ì‚°ì¬ì¬í™œ-í•˜ì§€': '1:1 ì¬í™œì¹˜ë£Œ',
            'ì‚°ì¬ì¬í™œ-ìƒì§€': '1:1 ì¬í™œì¹˜ë£Œ',
            'ì‚°ì¬ë¡œë´‡': 'ë¡œë´‡ë³´í–‰ì¹˜ë£Œ',
            'MM': 'ìš´ë™ì¹˜ë£Œâ…¡',
            'M15': 'ë„ìˆ˜ì¹˜ë£Œ',
            'RM': '1:1 ì¬í™œì¹˜ë£Œ',
            'RN': '1:1 ì¬í™œì¹˜ë£Œ',
            'RG': '1:1 ì¬í™œì¹˜ë£Œ',
            'RA': '1:1 ì¬í™œì¹˜ë£Œ',
            'RS': '1:1 ì¬í™œì¹˜ë£Œ',
            'RD': '1:1 ì¬í™œì¹˜ë£Œ(ì—°í•˜)',
            'N7': 'ë„ìˆ˜ì¹˜ë£Œ',
            'H7': 'ìƒì§€ë¡œë´‡ì¹˜ë£Œ',
            'O7': 'ë„ìˆ˜ì¹˜ë£Œ',
            'L7': 'ì–¸ì–´ì¹˜ë£Œ',
            'RL': 'ì–¸ì–´ì¹˜ë£Œ',
            'CA': 'ì‘ì—…ì¹˜ë£Œ',
            'rTMs': 'rTMs',
            'N': 'ìš´ë™ì¹˜ë£Œâ… ',
            'M': 'ìš´ë™ì¹˜ë£Œâ…¡',
            'F': 'ê¸°ëŠ¥ì ì „ê¸°ìê·¹ì¹˜ë£Œ',
            'D': 'ì—°í•˜ì¹˜ë£Œ',
            'H': 'í˜¸í¡ì¹˜ë£Œ',
            'W': 'ë¡œë´‡ë³´í–‰ì¹˜ë£Œ',
            'L': 'ì–¸ì–´ì¹˜ë£Œ',
            'P': 'ìˆ˜ì¤‘ì¹˜ë£Œ',
            'RP': 'ìˆ˜ì¤‘ì¹˜ë£Œ',
            '*': 'í†µì¦ì¹˜ë£Œ',
            'CPM': 'ìš´ë™ì¹˜ë£Œâ…¡',
            'COM': 'ìš´ë™ì¹˜ë£Œâ…¡',
            'Tt': 'ìš´ë™ì¹˜ë£Œâ…¡',
            'C': 'ì‘ì—…ì¹˜ë£Œ(15ë¶„)',
            'T': 'ìš´ë™ì¹˜ë£Œâ…¡',
            'V': '1:1 ì¬í™œì¹˜ë£Œ(ì—°í•˜)',
            'Y': 'ë°”ì´ì˜¤í”¼ë“œë°±',
            'TH': 'í†µì¦ì¹˜ë£Œ',
            'TI': 'í†µì¦ì¹˜ë£Œ',
            'TN': 'í†µì¦ì¹˜ë£Œ'
        };

        const FLOOR_MOVE_CODES = ['ì‚°ì¬ì¬í™œ-ìƒì§€', 'ì‚°ì¬ì¬í™œ-í•˜ì§€', 'rTMs', 'W', 'ì‚°ì¬ë¡œë´‡', 'H7', '*', 'P', 'RP', 'L', 'L7', 'RL', 'Y', 'TH', 'TI', 'TN'];
        const FLOOR_2F = ['ì‚°ì¬ì¬í™œ-ìƒì§€', 'ì‚°ì¬ì¬í™œ-í•˜ì§€', 'rTMs', 'W', 'ì‚°ì¬ë¡œë´‡', 'H7', '*', 'Y', 'TH', 'TI', 'TN'];
        const FLOOR_B1 = ['P', 'RP'];
        const SORTED_TREATMENT_KEYS = Object.keys(TREATMENT_CODES).sort((a, b) => b.length - a.length);
        const GROUP_MAPPING = { 'A': '(ì›”,ìˆ˜,ê¸ˆ)', 'B': '(í™”,ëª©)', 'D': '' };

        function getEl(id) { return document.getElementById(id); }

        function log(msg) {
            const b = getEl('debugWindow');
            b.innerText += "> " + msg + "\n";
            b.scrollTop = b.scrollHeight;
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function parseTimeMinutes(str) {
            if (!str) return null;
            const match = str.toString().trim().match(/([0-9]{1,2}):([0-9]{2})/);
            if (!match) return null;
            let h = parseInt(match[1]), m = parseInt(match[2]);
            if (h >= 1 && h <= 7) h += 12;
            return (h * 60) + m;
        }

        function resetAll() {
            if (!confirm("ëª¨ë“  íŒŒì¼ê³¼ ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            ['sat', 'sun'].forEach(day => {
                loadedFiles[day] = null;
                loadedWorkbooks[day] = null;
                getEl('file' + day.charAt(0).toUpperCase() + day.slice(1)).value = null;
                getEl('name' + day.charAt(0).toUpperCase() + day.slice(1)).innerHTML = '<span class="placeholder">ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span>';
                getEl('box' + day.charAt(0).toUpperCase() + day.slice(1)).classList.remove('locked');
            });
            getEl('patientInputList').value = "";
            getEl('previewList').innerHTML = "";
            getEl('previewList').style.display = 'none';
            getEl('debugWindow').innerText = "ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
        }

        function selectFile(day) {
            const boxId = 'box' + day.charAt(0).toUpperCase() + day.slice(1);
            const fileId = 'file' + day.charAt(0).toUpperCase() + day.slice(1);
            if (!getEl(boxId).classList.contains('locked')) getEl(fileId).click();
        }

        function clearFile(e, day) {
            e.stopPropagation();
            loadedFiles[day] = null;
            loadedWorkbooks[day] = null;
            const fileId = 'file' + day.charAt(0).toUpperCase() + day.slice(1);
            const nameId = 'name' + day.charAt(0).toUpperCase() + day.slice(1);
            const boxId = 'box' + day.charAt(0).toUpperCase() + day.slice(1);
            getEl(fileId).value = null;
            getEl(nameId).innerHTML = '<span class="placeholder">ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span>';
            getEl(boxId).classList.remove('locked');
            log("âŒ " + (day === 'sat' ? 'í† ìš”ì¼' : 'ì¼ìš”ì¼') + " íŒŒì¼ ì´ˆê¸°í™”ë¨.");
        }

        function processFile(file, day) {
            if (!file) return;
            const nameId = 'name' + day.charAt(0).toUpperCase() + day.slice(1);
            const boxId = 'box' + day.charAt(0).toUpperCase() + day.slice(1);
            getEl(nameId).innerHTML = file.name + ' <span class="clear-btn" onclick="clearFile(event, \'' + day + '\')">âŒ</span>';

            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // ëª¨ë“  ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì €ì¥
                    const allSheets = [];
                    workbook.SheetNames.forEach(sheetName => {
                        allSheets.push({
                            sheetName: sheetName,
                            data: XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, raw: false })
                        });
                    });

                    loadedFiles[day] = {
                        name: file.name,
                        sheets: allSheets  // ëª¨ë“  ì‹œíŠ¸ ì €ì¥
                    };
                    loadedWorkbooks[day] = {
                        name: file.name,
                        sheetNames: workbook.SheetNames,
                        rawData: new Uint8Array(e.target.result)
                    };

                    const sheetCount = workbook.SheetNames.length;
                    const sheetLabel = sheetCount > 1 ? `${sheetCount}ê°œ ì‹œíŠ¸` : workbook.SheetNames[0];
                    getEl(nameId).innerHTML = file.name + ' <span style="font-size:11px;color:#00695c;background:#e0f2f1;padding:2px 5px;border-radius:4px;vertical-align:middle;">' + sheetLabel + '</span> <span class="clear-btn" onclick="clearFile(event, \'' + day + '\')">âŒ</span>';
                    getEl(boxId).classList.add('locked');
                    const dayLabel = day === 'sat' ? 'í† ìš”ì¼' : 'ì¼ìš”ì¼';
                    log("âœ… " + dayLabel + " íŒŒì¼ ë¡œë“œ ì„±ê³µ! (ì‹œíŠ¸: " + workbook.SheetNames.join(', ') + ")");
                } catch (err) {
                    alert("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨.");
                    clearFile(event, day);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleFileSelect(day) {
            const fileId = 'file' + day.charAt(0).toUpperCase() + day.slice(1);
            processFile(getEl(fileId).files[0], day);
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        ['sat', 'sun'].forEach(day => {
            const boxId = 'box' + day.charAt(0).toUpperCase() + day.slice(1);
            const box = getEl(boxId);
            if (box) {
                box.addEventListener('dragover', e => {
                    e.preventDefault();
                    if (!box.classList.contains('locked')) box.classList.add('drag-over');
                });
                box.addEventListener('dragleave', e => {
                    e.preventDefault();
                    box.classList.remove('drag-over');
                });
                box.addEventListener('drop', e => {
                    e.preventDefault();
                    box.classList.remove('drag-over');
                    if (box.classList.contains('locked')) return;
                    const files = e.dataTransfer.files;
                    if (files.length > 0) processFile(files[0], day);
                });
            }
        });

        function analyzeCell(cellStr, patientName) {
            if (!cellStr) return null;
            let str = cellStr.toString();
            if (!str.replace(/\s/g, '').includes(patientName.replace(/\s/g, ''))) return null;

            if (str.includes('\n')) {
                const lines = str.split('\n');
                const matchLine = lines.find(l => l.replace(/\s/g, '').includes(patientName.replace(/\s/g, '')));
                if (matchLine) str = matchLine;
                else return null;
            }

            const cleanStr = str.replace(new RegExp(patientName, 'gi'), '').trim().toUpperCase();

            // RG...R íŒ¨í„´ (ë¡œë´‡ë³´í–‰ì¹˜ë£Œ)
            if (/^RG.+R$/.test(cleanStr)) {
                const suffixes = [];
                const rem = str.replace(new RegExp(patientName, 'gi'), '').replace(/RG/gi, '').replace(/R$/i, '');
                const parens = rem.match(/\([^\)]+\)/g);
                if (parens) suffixes.push(...parens);
                (rem.match(/\b[AB]\b/g) || []).forEach(g => suffixes.push(GROUP_MAPPING[g] || g));
                return { found: true, name: 'ë¡œë´‡ë³´í–‰ì¹˜ë£Œ', remark: suffixes.join(''), floorMove: true, floorNote: '2ì¸µ' };
            }

            // ì¹˜ë£Œ ì½”ë“œ ë§¤ì¹­
            for (let i = 0; i < SORTED_TREATMENT_KEYS.length; i++) {
                const k = SORTED_TREATMENT_KEYS[i];
                if (cleanStr.startsWith(k.toUpperCase()) || cleanStr === k.toUpperCase()) {
                    const safeKey = escapeRegExp(k);
                    let rem = str.replace(new RegExp(patientName, 'gi'), '').replace(new RegExp(safeKey, 'gi'), '').replace(/[\[\]]/g, ' ');
                    const suffixes = [];
                    const parens = rem.match(/\([^\)]+\)/g);
                    if (parens) suffixes.push(...parens);
                    (rem.match(/\b[AB]\b/g) || []).forEach(g => suffixes.push(GROUP_MAPPING[g] || g));
                    const under = rem.match(/_[^\s,]+/g);
                    if (under) suffixes.push(...under);
                    return {
                        found: true,
                        name: TREATMENT_CODES[k],
                        remark: suffixes.join(''),
                        floorMove: FLOOR_MOVE_CODES.includes(k),
                        floorNote: FLOOR_2F.includes(k) ? '2ì¸µ' : FLOOR_B1.includes(k) ? 'ì§€í•˜1ì¸µ' : ''
                    };
                }
            }

            // S ì ‘ë‘ì‚¬ íŒ¨í„´
            if (/^S/.test(cleanStr) && !/^S.*S$/.test(cleanStr) && cleanStr.length <= 10) {
                const suffixes = [];
                const rem = str.replace(new RegExp(patientName, 'gi'), '').replace(/^S/i, '');
                const parens = rem.match(/\([^\)]+\)/g);
                if (parens) suffixes.push(...parens);
                (rem.match(/\b[AB]\b/g) || []).forEach(g => suffixes.push(GROUP_MAPPING[g] || g));
                return { found: true, name: '1:1 ì¬í™œì¹˜ë£Œ', remark: suffixes.join(''), floorMove: false, floorNote: '' };
            }

            // S ì ‘ë¯¸ì‚¬ íŒ¨í„´
            if (/S$/.test(cleanStr) && !/^S/.test(cleanStr) && cleanStr.length <= 10) {
                const suffixes = [];
                const rem = str.replace(new RegExp(patientName, 'gi'), '').replace(/S$/i, '');
                const parens = rem.match(/\([^\)]+\)/g);
                if (parens) suffixes.push(...parens);
                (rem.match(/\b[AB]\b/g) || []).forEach(g => suffixes.push(GROUP_MAPPING[g] || g));
                return { found: true, name: 'ìš´ë™ì¹˜ë£Œâ…¡', remark: suffixes.join(''), floorMove: false, floorNote: '' };
            }

            return { found: false, rawText: str };
        }

        // ë‹¨ì¼ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œí•˜ëŠ” ë‚´ë¶€ í•¨ìˆ˜
        function extractFromSingleSheet(sheetData, sheetName, patientName, aggData, floorData, unknownTracker, dayType) {
            const timeRegex = /[0-9]{1,2}:[0-9]{2}/;
            const isFloor2Sheet = sheetName && sheetName.includes('2ì¸µ');
            const isSunday = dayType === 'sun';  // ì¼ìš”ì¼ ì—¬ë¶€

            const data = sheetData;
            let hIdx = -1, maxCnt = 0;

            for (let i = 0; i < Math.min(30, data.length); i++) {
                let cnt = 0;
                const row = data[i] || [];
                for (let j = 0; j < row.length; j++) {
                    if (row[j] && timeRegex.test(row[j].toString())) cnt++;
                }
                if (cnt > maxCnt) {
                    maxCnt = cnt;
                    hIdx = i;
                }
            }

            if (hIdx === -1) return;

            const colMap = {};
            let lastMin = null;
            data[hIdx].forEach((c, idx) => {
                const m = parseTimeMinutes(c);
                if (m !== null) {
                    colMap[idx] = m;
                    lastMin = m;
                } else if (lastMin !== null && (!c || !c.toString().trim())) {
                    colMap[idx] = lastMin;
                }
            });

            for (let r = hIdx + 1; r < data.length; r++) {
                const row = data[r];
                if (!row) continue;

                let skip = false;
                const keys = ["ì¶”ê°€", "N", "CA", "D", "C"];
                for (let c = 0; c < 5; c++) {
                    const v = row[c] ? row[c].toString().trim() : "";
                    if (keys.includes(v)) {
                        skip = true;
                        break;
                    }
                }
                if (skip) continue;

                row.forEach((cell, c) => {
                    const tm = colMap[c];
                    if (!tm) return;
                    // ì˜¤ì „ ì‹œê°„ë§Œ ì²˜ë¦¬ (08:30~12:30 = 510~750ë¶„)
                    if (tm < 510 || tm > 750) return;

                    const res = analyzeCell(cell, patientName);
                    if (res) {
                        if (res.found) {
                            // 2ì¸µ ì‹œíŠ¸ë©´ ëª¨ë“  ì¹˜ë£Œì— ì¸µ ì´ë™ í‘œì‹œ
                            const showFloorMove = isFloor2Sheet || res.floorMove;
                            const txt = (showFloorMove ? '<b style="color:red">â†“</b>' : '') + res.name +
                                (showFloorMove ? '<b style="color:red">â†‘</b>' : '') +
                                (res.remark ? " " + res.remark : "");
                            // ì¼ìš”ì¼ì´ë©´ "6ì¸µ", 2ì¸µ ì‹œíŠ¸ë©´ "2ì¸µ" í‘œì‹œ
                            const floorTxt = isSunday ? '6ì¸µ' : (isFloor2Sheet ? '2ì¸µ' : (res.floorNote || ""));
                            if (floorTxt && !floorData[tm]) floorData[tm] = floorTxt;
                            aggData[tm] = aggData[tm] ? (aggData[tm].includes(txt) ? aggData[tm] : aggData[tm] + "\n" + txt) : txt;
                        } else {
                            unknownTracker.push(`[${patientName}] ${tm}ë¶„ : "${res.rawText}"`);
                        }
                    }
                });
            }
        }

        // ëª¨ë“  ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
        function extractScheduleData(fileData, patientName, unknownTracker, dayType) {
            const aggData = {};
            const floorData = {};

            if (!fileData || !fileData.sheets) return { aggData, floorData, hasTreatment: false };

            // ëª¨ë“  ì‹œíŠ¸ë¥¼ ìˆœíšŒí•˜ë©° ë°ì´í„° ì¶”ì¶œ
            fileData.sheets.forEach(sheet => {
                extractFromSingleSheet(sheet.data, sheet.sheetName, patientName, aggData, floorData, unknownTracker, dayType);
            });

            const hasTreatment = Object.keys(aggData).length > 0;
            return { aggData, floorData, hasTreatment };
        }

        function createHalfScheduleHTML(dayType, pName, rNum, aggData, floorData, hasTreatment, dateStr) {
            const dayLabel = dayType === 'sat' ? 'í† ìš”ì¼' : 'ì¼ìš”ì¼';
            const dayBadgeClass = dayType === 'sat' ? 'sat' : 'sun';
            const dateDisplay = dateStr ? formatDateKorean(dateStr) : dayLabel;

            // ì¹˜ë£Œ ì—†ëŠ” ë‚ ì€ ê°„ë‹¨í•œ ì•ˆë‚´ ë¬¸êµ¬ë§Œ í‘œì‹œ
            if (!hasTreatment) {
                return `
                    <div class="half-schedule no-treatment-simple">
                        <div class="no-treatment-message">
                            <span class="day-badge ${dayBadgeClass}">${dateDisplay}</span>
                            <span class="no-tx-text">ì¹˜ë£Œ ì—†ìŒ</span>
                        </div>
                    </div>
                `;
            }

            let tbody = "";
            let amF = false;

            WEEKEND_SCHEDULE_SLOTS.forEach(slot => {
                let content = "";
                let floorContent = "";

                for (const tStr in aggData) {
                    if (Math.abs(parseInt(tStr) - slot.targetMin) <= 2) {
                        content = aggData[tStr];
                        floorContent = floorData[tStr] || "";
                    }
                }

                let row = '<tr>';
                if (!amF) {
                    row += '<td rowspan="14" class="col-ampm"><div class="text-vertical">ì˜¤ì „</div></td>';
                    amF = true;
                }
                row += `<td rowspan="2" class="col-num">${slot.id}</td><td class="col-time row-height">${slot.times[0]}</td>`;
                row += `<td rowspan="2" class="treatment-text" contenteditable="true">${content}</td><td rowspan="2" class="col-remark" contenteditable="true">${floorContent}</td></tr>`;
                row += `<tr><td class="col-time row-height">${slot.times[1]}</td></tr>`;
                tbody += row;
            });

            return `
                <div class="half-schedule">
                    <div class="doc-header">
                        <div class="logo-area">
                            <div class="cl-logo"><span class="cl-c">C</span><span class="cl-l">L</span></div>
                        </div>
                        <div class="main-title">ì£¼ë§ ì¬í™œì¹˜ë£Œ ì‹œê°„í‘œ<span class="day-badge ${dayBadgeClass}">${dateDisplay}</span></div>
                    </div>
                    <div class="patient-info">
                        <span class="info-underline" contenteditable="true">${rNum}</span>í˜¸ &nbsp;&nbsp;
                        <span class="info-underline" contenteditable="true">${pName}</span> ë‹˜
                    </div>
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th colspan="3">ì‹œ ê°„</th>
                                <th>ì¹˜ë£Œ í•­ëª©</th>
                                <th>ë¹„ ê³ </th>
                            </tr>
                        </thead>
                        <tbody>${tbody}</tbody>
                    </table>
                </div>
            `;
        }

        async function generateAllSchedules() {
            const input = getEl('patientInputList').value.trim();
            const prevList = getEl('previewList');
            getEl('debugWindow').innerText = "";
            prevList.innerHTML = "";
            prevList.style.display = 'none';

            if (!loadedFiles.sat && !loadedFiles.sun) {
                return alert("ìµœì†Œ í•˜ë‚˜ì˜ íŒŒì¼(í† ìš”ì¼ ë˜ëŠ” ì¼ìš”ì¼)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            }
            if (!input) return alert("í™˜ì ëª©ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            let folderFiles = {};
            if (globalDirHandle) {
                try {
                    log("ğŸ“‚ í´ë”ì—ì„œ ê¸°ì¡´ íŒŒì¼ ê²€ìƒ‰ ì¤‘...");
                    let files = {};
                    if (globalDirHandle === "PARENT") {
                        files = await parent.listFolderFilesFromParent();
                    } else {
                        // ì§ì ‘ FileSystemDirectoryHandle ì‚¬ìš©
                        for await (const entry of globalDirHandle.values()) {
                            if (entry.kind === 'file') {
                                files[entry.name] = entry;
                            }
                        }
                    }
                    for (const fname in files) {
                        // ì£¼ë§ ì‹œê°„í‘œ í˜•ì‹: ì´ë¦„-ì°¨íŠ¸ë²ˆí˜¸-í˜¸ì‹¤-ì£¼ë§.html
                        let match = fname.match(/^(.+?)-([^-]+)-([^-]+)-ì£¼ë§\.html$/);
                        if (match) {
                            const [_, name, num, room] = match;
                            folderFiles[name] = { num, room, fileName: fname };
                            log("ğŸ“„ ë°œê²¬(ì£¼ë§): " + fname);
                        } else {
                            // ì¼ë°˜ í˜•ì‹: ì´ë¦„-ì°¨íŠ¸ë²ˆí˜¸-í˜¸ì‹¤.html (ì•„ì¹¨/ì˜¤í›„ ì‹œê°„í‘œ ë“±)
                            match = fname.match(/^(.+?)-([^-]+)-([^-]+)(?:-[^.]+)?\.html$/);
                            if (match) {
                                const [_, name, num, room] = match;
                                if (!folderFiles[name]) {  // ì£¼ë§ íŒŒì¼ì´ ì—†ì„ ë•Œë§Œ ë‹¤ë¥¸ íŒŒì¼ ì‚¬ìš©
                                    folderFiles[name] = { num, room, fileName: fname };
                                    log("ğŸ“„ ë°œê²¬(ê¸°íƒ€): " + fname);
                                }
                            }
                        }
                    }
                } catch (e) {
                    log("âš ï¸ í´ë” ì½ê¸° ì˜¤ë¥˜: " + e.message);
                }
            }

            const lines = input.split('\n').filter(l => l.trim() !== "");
            log("ğŸš€ ì´ " + lines.length + "ëª… ë°ì´í„° ìƒì„± ì¤‘...");

            generatedPatients = [];
            const unknownLog = [];

            for (const line of lines) {
                const parts = line.trim().split(/\s+/);
                let pNum = "______", pRoom = "____", pName = "";

                if (parts.length >= 3) {
                    pName = parts[0];
                    pNum = parts[1];
                    pRoom = parts[2];
                } else if (parts.length === 2) {
                    pName = parts[0];
                    pRoom = parts[1];
                } else {
                    pName = parts[0];
                    if (folderFiles[pName]) {
                        pNum = folderFiles[pName].num;
                        pRoom = folderFiles[pName].room;
                        log("âœ¨ ìë™ì™„ì„±: " + pName + " â†’ " + pNum + "-" + pRoom);
                    }
                }

                // í† ìš”ì¼ ë°ì´í„° ì¶”ì¶œ (ëª¨ë“  ì‹œíŠ¸ì—ì„œ ê²€ìƒ‰)
                const satData = extractScheduleData(loadedFiles.sat, pName, unknownLog, 'sat');
                // ì¼ìš”ì¼ ë°ì´í„° ì¶”ì¶œ (ëª¨ë“  ì‹œíŠ¸ì—ì„œ ê²€ìƒ‰, ë¹„ê³ ë€ì— "6ì¸µ" í‘œì‹œ)
                const sunData = extractScheduleData(loadedFiles.sun, pName, unknownLog, 'sun');

                const satHtml = createHalfScheduleHTML('sat', pName, pRoom, satData.aggData, satData.floorData, satData.hasTreatment, weekendDates.sat);
                const sunHtml = createHalfScheduleHTML('sun', pName, pRoom, sunData.aggData, sunData.floorData, sunData.hasTreatment, weekendDates.sun);

                const combinedHtml = satHtml + sunHtml;

                generatedPatients.push({
                    num: pNum,
                    room: pRoom,
                    name: pName,
                    html: combinedHtml,
                    satHasTreatment: satData.hasTreatment,
                    sunHasTreatment: sunData.hasTreatment
                });
            }

            // ì •ë ¬ ì ìš©
            const sortOption = getEl('sortOption').value;
            if (sortOption === 'room') {
                generatedPatients.sort((a, b) => {
                    const roomA = parseInt(a.room) || 0;
                    const roomB = parseInt(b.room) || 0;
                    return roomA - roomB;
                });
                log("ğŸ“Š í˜¸ì‹¤ë³„ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ ì ìš©");
            } else if (sortOption === 'room-desc') {
                generatedPatients.sort((a, b) => {
                    const roomA = parseInt(a.room) || 0;
                    const roomB = parseInt(b.room) || 0;
                    return roomB - roomA;
                });
                log("ğŸ“Š í˜¸ì‹¤ë³„ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ì ìš©");
            } else if (sortOption === 'name') {
                generatedPatients.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                log("ğŸ“Š ì´ë¦„ìˆœ ì •ë ¬ ì ìš©");
            }

            // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
            for (const patient of generatedPatients) {
                const wrapper = document.createElement('div');
                wrapper.className = 'preview-item-wrapper';
                wrapper.innerHTML = '<div class="preview-paper">' + patient.html + '</div>';
                prevList.appendChild(wrapper);
            }

            if (generatedPatients.length) {
                prevList.style.display = 'flex';
                log("âœ… ì™„ë£Œ! ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.");
                setTimeout(() => prevList.scrollIntoView({ behavior: 'smooth' }), 300);

                if (unknownLog.length > 0) {
                    const uniqueUnknown = [...new Set(unknownLog)];
                    alert("ğŸš¨ ë¯¸ì¸ì‹ ì¹˜ë£Œ í•­ëª© ë°œê²¬! ë¡œê·¸ í™•ì¸.");
                    log("\n=== ğŸš¨ ë¯¸ì¸ì‹ ë°ì´í„° ===\n" + uniqueUnknown.join('\n'));
                }

                // ì¹˜ë£Œ ì—†ëŠ” í™˜ì ì•Œë¦¼
                const noTreatmentPatients = generatedPatients.filter(p => !p.satHasTreatment && !p.sunHasTreatment);
                if (noTreatmentPatients.length > 0) {
                    log("\nâš ï¸ í† /ì¼ ëª¨ë‘ ì¹˜ë£Œ ì—†ëŠ” í™˜ì: " + noTreatmentPatients.map(p => p.name).join(', '));
                }
            }
        }

        function syncPreviewToPrint() {
            const cont = getEl('printContainer');
            cont.innerHTML = "";
            const papers = document.querySelectorAll('#previewList .preview-paper');

            // 2ëª…ì”© ì¢Œìš°ë¡œ ë°°ì¹˜
            let rowContent = "";
            let cnt = 0;
            papers.forEach((paperEl, i) => {
                rowContent += '<div class="print-half">' + paperEl.innerHTML + '</div>';
                cnt++;
                if (cnt === 2 || i === papers.length - 1) {
                    const row = document.createElement('div');
                    row.className = 'print-page-row';
                    row.innerHTML = rowContent;
                    cont.appendChild(row);
                    rowContent = "";
                    cnt = 0;
                }
            });
        }

        function printWithGuide() {
            if (!getEl('previewList').innerHTML.trim()) return alert("ì‹œê°„í‘œë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.");
            syncPreviewToPrint();
            window.print();
        }

        async function setSaveFolder() {
            try {
                // parent.selectFolderFromParentê°€ ìˆìœ¼ë©´ ì‚¬ìš© (iframe ë‚´ë¶€ì—ì„œ ì‹¤í–‰ ì‹œ)
                if (typeof parent !== 'undefined' && typeof parent.selectFolderFromParent === 'function') {
                    const result = await parent.selectFolderFromParent();
                    if (result.success) {
                        globalDirHandle = "PARENT";
                        log("ğŸ“‚ í´ë” ì—°ê²°ë¨: " + result.name);
                        const status = getEl('folderStatus');
                        status.innerText = "âœ… ì—°ê²°ë¨: " + result.name;
                        status.style.display = 'block';
                        status.style.color = 'green';
                        alert("ì„±ê³µ! [HTML ì €ì¥] ì‹œ " + result.name + " í´ë”ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.");
                    } else if (result.error && result.error !== "cancelled") {
                        alert(result.error);
                    }
                }
                // ì§ì ‘ ì‹¤í–‰ ì‹œ File System Access API ì‚¬ìš©
                else if (window.showDirectoryPicker) {
                    const dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                    globalDirHandle = dirHandle;
                    log("ğŸ“‚ í´ë” ì—°ê²°ë¨: " + dirHandle.name);
                    const status = getEl('folderStatus');
                    status.innerText = "âœ… ì—°ê²°ë¨: " + dirHandle.name;
                    status.style.display = 'block';
                    status.style.color = 'green';
                    alert("ì„±ê³µ! [HTML ì €ì¥] ì‹œ " + dirHandle.name + " í´ë”ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.");
                } else {
                    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë” ì„ íƒ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nChrome, Edge ë“± ìµœì‹  ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    // ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨ - ì•„ë¬´ê²ƒë„ ì•ˆí•¨
                    return;
                }
                alert("í´ë” ì„ íƒ ì˜¤ë¥˜: " + err.message);
            }
        }

        async function saveAsWord() {
            if (!generatedPatients.length) return alert("ë¨¼ì € ì‹œê°„í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");

            const papers = document.querySelectorAll('#previewList .preview-paper');
            if (!papers.length) return alert("ìƒì„±ëœ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.");

            const btn = document.querySelector('.btn-word');
            const orig = btn.innerText;
            btn.innerText = "âš¡ ì €ì¥ ì¤‘...";
            btn.disabled = true;

            const useFS = !!globalDirHandle;
            const useParentFS = globalDirHandle === "PARENT";
            let existingFiles = {};
            if (useFS) {
                try {
                    if (useParentFS) {
                        existingFiles = await parent.listFolderFilesFromParent();
                    } else {
                        // ì§ì ‘ FileSystemDirectoryHandle ì‚¬ìš©
                        for await (const entry of globalDirHandle.values()) {
                            if (entry.kind === 'file') {
                                existingFiles[entry.name] = entry;
                            }
                        }
                    }
                } catch (e) {
                    log("âš ï¸ í´ë” ì½ê¸° ì˜¤ë¥˜: " + e.message);
                }
            }

            const total = generatedPatients.length;
            let saved = 0, skipped = 0;
            log("\nğŸ“ ì´ " + total + "ëª… ì €ì¥ ì‹œì‘...");

            for (let i = 0; i < total; i++) {
                const patient = generatedPatients[i];
                const paper = papers[i];
                if (!paper) continue;

                const pName = patient.name;
                btn.innerText = `âš¡ ${i + 1}/${total}`;

                // ê¸°ì¡´ íŒŒì¼ì—ì„œ ì°¨íŠ¸ë²ˆí˜¸/í˜¸ì‹¤ ì¶”ì¶œ ì‹œë„
                let pNum = patient.num;
                let pRoom = patient.room;

                if (useFS) {
                    // ë¨¼ì € ì£¼ë§ íŒŒì¼ì—ì„œ ì •ë³´ ì°¾ê¸°
                    for (const fname in existingFiles) {
                        if (fname.includes(patient.name)) {
                            // ì£¼ë§ íŒŒì¼ í˜•ì‹: ì´ë¦„-ì°¨íŠ¸ë²ˆí˜¸-í˜¸ì‹¤-ì£¼ë§.html
                            let match = fname.match(/^.+?-([^-]+)-([^-]+)-ì£¼ë§\.html$/);
                            if (match) {
                                pNum = match[1];
                                pRoom = match[2];
                                log("ğŸ“‹ ê¸°ì¡´ ì£¼ë§ íŒŒì¼ì—ì„œ ì •ë³´ ì¶”ì¶œ: " + pNum + "-" + pRoom);
                                break;
                            }
                            // ì¼ë°˜ íŒŒì¼ í˜•ì‹: ì´ë¦„-ì°¨íŠ¸ë²ˆí˜¸-í˜¸ì‹¤.html ë˜ëŠ” ì´ë¦„-ì°¨íŠ¸ë²ˆí˜¸-í˜¸ì‹¤-ì•„ì¹¨.html
                            match = fname.match(/^.+?-([^-]+)-([^-]+)(?:-[^.]+)?\.html$/);
                            if (match && (pNum === "______" || pNum === "____")) {
                                pNum = match[1];
                                pRoom = match[2];
                                log("ğŸ“‹ ê¸°ì¡´ íŒŒì¼ì—ì„œ ì •ë³´ ì¶”ì¶œ: " + pNum + "-" + pRoom);
                            }
                        }
                    }
                }

                let targetFileName = patient.name + "-" + pNum + "-" + pRoom + "-ì£¼ë§.html";
                log("ğŸ“ " + pName + " ë¬¸ì„œ ìƒì„± ì¤‘...");

                if (useFS) {
                    let existingFile = null;
                    for (const fname in existingFiles) {
                        if (fname.includes(patient.name) && fname.includes('ì£¼ë§')) {
                            targetFileName = fname;
                            existingFile = existingFiles[fname];
                            break;
                        }
                    }
                    if (existingFile) {
                        const shouldOverwrite = confirm(`[${targetFileName}] íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.\n\në®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`);
                        if (!shouldOverwrite) {
                            log("â­ï¸ ê±´ë„ˆëœ€: " + targetFileName);
                            skipped++;
                            continue;
                        }
                    }
                }

                try {
                    const cssStyle = `<style>
                        :root { --main-color: #00695c; --sat-color: #1565C0; --sun-color: #C62828; }
                        .save-toolbar { position: fixed; top: 10px; right: 10px; z-index: 9999; display: flex; gap: 8px; }
                        .save-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
                        .save-btn.primary { background: #00695c; color: white; }
                        .save-btn.secondary { background: #ff5722; color: white; }
                        .print-page-row { width: 297mm; height: 210mm; margin: 0 auto; background: white; display: flex; flex-direction: row; padding: 0; }
                        .print-half { width: 50%; height: 100%; padding: 5mm 7mm; box-sizing: border-box; zoom: 0.72; border-right: 1px dashed #ddd; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
                        .print-half:last-child { border-right: none; }
                        .half-schedule { width: 100%; height: 50%; padding: 2mm 0; box-sizing: border-box; position: relative; }
                        .half-schedule:first-child { border-bottom: 1px dashed #ccc; }
                        .half-schedule.no-treatment { background: #f5f5f5; }
                        .half-schedule.no-treatment .schedule-table td.treatment-text,
                        .half-schedule.no-treatment .schedule-table td.col-remark { background: #e0e0e0; color: #9e9e9e; }
                        .no-treatment-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; color: #9e9e9e; background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 8px; z-index: 10; display: none; }
                        .half-schedule.no-treatment .no-treatment-overlay { display: block; }
                        .no-treatment-simple { display: flex; align-items: center; justify-content: center; background: #fafafa; }
                        .no-treatment-message { display: flex; align-items: center; gap: 15px; padding: 20px 30px; background: white; border: 2px dashed #ccc; border-radius: 12px; }
                        .no-treatment-message .day-badge { font-size: 16px; padding: 5px 15px; margin-left: 0; }
                        .no-tx-text { font-size: 22px; font-weight: bold; color: #9e9e9e; }
                        @media print {
                            @page { size: A4 landscape; margin: 0; }
                            html, body { margin: 0 !important; padding: 0 !important; }
                            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                            .save-toolbar { display: none !important; }
                            .print-page-row { width: 297mm; height: 210mm; margin: 0; padding: 0; box-shadow: none; }
                            .print-half { width: 50%; height: 100%; padding: 5mm 7mm; box-sizing: border-box; zoom: 0.72; box-shadow: none; border-right: 1px dashed #ddd; }
                            .print-half:last-child { border-right: none; }
                        }
                        body { background: #f5f5f5; padding: 10mm; font-family: 'Pretendard', sans-serif; }
                        .doc-header { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 3px; border-bottom: 3px solid var(--main-color); padding-bottom: 5px; }
                        .cl-logo { font-size: 28px; font-weight: bold; font-style: italic; line-height: 1; }
                        .cl-c { color: #d4a017; }
                        .cl-l { color: #006400; }
                        .main-title { font-size: 22px; font-weight: bold; text-align: center; flex: 1; letter-spacing: -1px; }
                        .day-badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 14px; font-weight: bold; margin-left: 8px; }
                        .day-badge.sat { background: var(--sat-color); color: white; }
                        .day-badge.sun { background: var(--sun-color); color: white; }
                        .patient-info { margin: 6px 0 8px; font-size: 18px; font-weight: bold; }
                        .info-underline { display: inline-block; border-bottom: 2px solid #333; min-width: 70px; text-align: center; padding: 0 5px; color: var(--main-color); }
                        .schedule-table { width: 100%; border-collapse: collapse; border-top: 2px solid #000; border-bottom: 2px solid #000; margin-top: 5px; }
                        .schedule-table th, .schedule-table td { border: 1px solid #000; text-align: center; vertical-align: middle; padding: 0; font-weight: bold; }
                        .schedule-table th { background: #e0f2f1; height: 28px; font-size: 14px; }
                        .row-height { height: 28px; }
                        .col-ampm { width: 28px; background: #f9f9f9; font-weight: bold; font-size: 13px; color: #444; white-space: nowrap; }
                        .col-num { width: 28px; font-weight: bold; font-size: 14px; font-family: "Times New Roman"; }
                        .col-time { width: 100px; font-weight: bold; font-size: 15px; font-family: "Times New Roman"; letter-spacing: -0.5px; white-space: nowrap; }
                        .treatment-text { width: auto; font-size: 24px; font-weight: 900; white-space: pre-line; line-height: 1.1; color: #000; }
                        .col-remark { font-size: 22px; font-weight: bold; white-space: nowrap; padding: 0 5px; color: #333; }
                        .text-vertical { writing-mode: vertical-lr; text-orientation: upright; letter-spacing: 3px; }
                    </style>`;

                    const saveScript = `<script>
                        let fileHandle = null;
                        const TOOLBAR_HTML = '<div class="save-toolbar"><button class="save-btn primary" onclick="saveFile()">ğŸ’¾ ì €ì¥</button><button class="save-btn secondary" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button></div>';
                        async function saveFile() {
                            const btn = document.querySelector('.save-btn.primary');
                            const origText = 'ğŸ’¾ ì €ì¥';
                            try {
                                btn.innerText = 'ì €ì¥ ì¤‘...';
                                btn.disabled = true;
                                const fileName = document.body.dataset.filename;
                                const content = document.querySelector('.print-page-row').outerHTML;
                                const html = '<!DOCTYPE html><html><head>' + document.head.innerHTML + '</head><body data-filename="' + fileName + '">' + TOOLBAR_HTML + content + '</body></html>';
                                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                                if (window.showSaveFilePicker) {
                                    if (!fileHandle) {
                                        fileHandle = await window.showSaveFilePicker({
                                            suggestedName: fileName,
                                            types: [{ description: 'HTML', accept: { 'text/html': ['.html'] } }]
                                        });
                                    }
                                    const writable = await fileHandle.createWritable();
                                    await writable.write(blob);
                                    await writable.close();
                                    btn.innerText = 'âœ… ì €ì¥ë¨!';
                                    setTimeout(() => { btn.innerText = origText; }, 1500);
                                } else {
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = fileName;
                                    a.click();
                                    URL.revokeObjectURL(url);
                                    btn.innerText = 'âœ… ë‹¤ìš´ë¡œë“œë¨!';
                                    setTimeout(() => { btn.innerText = origText; }, 1500);
                                }
                            } catch (e) {
                                if (e.name !== 'AbortError') alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
                                btn.innerText = origText;
                            } finally {
                                btn.disabled = false;
                            }
                        }
                    <\/script>`;

                    const htmlContent = `<!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>${pName} ì£¼ë§ ì‹œê°„í‘œ</title>
                            ${cssStyle}
                            ${saveScript}
                        </head>
                        <body data-filename="${targetFileName}">
                            <div class="save-toolbar">
                                <button class="save-btn primary" onclick="saveFile()">ğŸ’¾ ì €ì¥</button>
                                <button class="save-btn secondary" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
                            </div>
                            <div class="print-page-row"><div class="print-half">${paper.innerHTML}</div></div>
                        </body>
                        </html>`;

                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                    log("ğŸ“¦ " + pName + " íŒŒì¼ ìƒì„± ì™„ë£Œ");

                    if (useFS) {
                        if (useParentFS) {
                            const saveResult = await parent.saveFileFromParent(targetFileName, blob);
                            if (saveResult.success) {
                                log("âœ… ì €ì¥: " + targetFileName);
                                saved++;
                            } else {
                                log("âŒ ì €ì¥ì‹¤íŒ¨: " + saveResult.error);
                            }
                        } else {
                            // ì§ì ‘ FileSystemDirectoryHandle ì‚¬ìš©
                            try {
                                const fileHandle = await globalDirHandle.getFileHandle(targetFileName, { create: true });
                                const writable = await fileHandle.createWritable();
                                await writable.write(blob);
                                await writable.close();
                                log("âœ… ì €ì¥: " + targetFileName);
                                saved++;
                            } catch (fsErr) {
                                log("âŒ ì €ì¥ì‹¤íŒ¨: " + fsErr.message);
                            }
                        }
                    } else {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = targetFileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        log("ğŸ’¾ ë‹¤ìš´ë¡œë“œ: " + targetFileName);
                        saved++;
                        await new Promise(r => setTimeout(r, 500));
                    }
                } catch (err) {
                    log("âŒ ì‹¤íŒ¨: " + pName + " - " + err.message);
                    console.error(err);
                }
            }

            btn.innerText = orig;
            btn.disabled = false;
            alert(`âœ… ì™„ë£Œ!\nì €ì¥: ${saved}ëª…${skipped ? ("\nê±´ë„ˆëœ€: " + skipped + "ëª…") : ""}\n\nğŸ’¡ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ í´ë¦­ìœ¼ë¡œ í¸ì§‘ ê°€ëŠ¥!`);
            log("\nğŸ‰ ì €ì¥ ì™„ë£Œ!");
        }
    </script>
</body>
</html>
